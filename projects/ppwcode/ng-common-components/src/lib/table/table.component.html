<section class="ppw-table-container" [class.fixed-height]="hasFixedHeight">
    <table
        mat-table
        #dataTable
        class="ppw-table"
        [class.ppw-table-header-hidden]="!!options?.header?.hidden"
        [class.ppw-table-header-hidden-first-row-add-top-border]="
            !!options?.header?.hidden && !!options?.header?.showFirstRowTopBorder
        "
        [dataSource]="dataSource"
        [trackBy]="trackByFn"
        cdkDropList
        [cdkDropListData]="dataSource"
        (cdkDropListDropped)="dropTable($event)">
        <!-- Draghandle column -->
        <ng-container matColumnDef="rowDrag" *ngIf="enableRowDrag">
            <th mat-header-cell *matHeaderCellDef></th>
            <td mat-cell *matCellDef="let element" class="drag-table-cell">
                <mat-icon
                    cdkDragHandle
                    mat-ripple
                    class="drag-handle"
                    (touchstart)="dragDisabled = false"
                    (touchend)="dragDisabled = true"
                    (mousedown)="dragDisabled = false"
                    (mouseup)="dragDisabled = true"
                    >drag_indicator</mat-icon
                >
            </td>
        </ng-container>

        <!-- Checkbox Column -->
        <ng-container matColumnDef="rowSelection" *ngIf="enableRowSelection">
            <th mat-header-cell *matHeaderCellDef>
                <mat-checkbox
                    color="primary"
                    [style.width]="options?.columnWidths?.['rowSelection']"
                    (change)="$event ? masterToggle() : null"
                    [checked]="isAllSelected()"
                    [indeterminate]="isSomeSelected()">
                </mat-checkbox>
            </th>
            <td mat-cell *matCellDef="let row">
                <mat-checkbox
                    color="primary"
                    [style.width]="options?.columnWidths?.['rowSelection']"
                    (change)="$event ? selection.toggle(row) : null"
                    [checked]="selection.isSelected(row)">
                </mat-checkbox>
            </td>
        </ng-container>

        <ng-container *ngFor="let column of columns" [matColumnDef]="column.name">
            <th
                mat-header-cell
                [style.width]="options?.columnWidths?.[column.name]"
                [ngStyle]="options?.header?.styles?.[column.name]?.()"
                *matHeaderCellDef
                class="ppw-column-type-{{ column.type }}">
                <ng-container *ngIf="(options?.header?.templates?.[column.name]?.()); else textTemplateContainer">
                    <ng-container
                        *ngTemplateOutlet="headerTemplateCellTemplate; context: { headerTemplate: (options?.header?.templates?.[column.name]()) }"></ng-container>
                </ng-container>
                <ng-template #textTemplateContainer>
                    <ng-container *ngTemplateOutlet="headerTextCellTemplate; context: { column }"></ng-container>
                </ng-template>
            </th>
            <td
                mat-cell
                [style.width]="options?.columnWidths?.[column.name]"
                [ngStyle]="options?.columnStyles?.[column.name]?.(record.initialRecord)"
                *matCellDef="let record; let idx = index"
                (click)="executeRowClick(record.initialRecord, column.name)"
                class="ppw-column-type-{{ column.type }}">
                <ng-container
                    ppwDynamicCell
                    [rowIndex]="idx"
                    [column]="column"
                    [record]="record.initialRecord"
                    [value]="record.mappedValues[column.name]"></ng-container>
            </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="columnNames; sticky: !!options?.header?.sticky"></tr>
        <tr
            mat-row
            @rowsAnimation
            *matRowDef="let row; columns: columnNames"
            cdkDrag
            [cdkDragDisabled]="dragDisabled"
            (cdkDragReleased)="dragDisabled = true"
            [class.highlight]="options?.rowHighlightOnHover"
            [class.clickable]="options?.rowClickAction"></tr>
        <div *cdkDragPlaceholder></div>
    </table>
</section>

<ng-template #headerTemplateCellTemplate let-headerTemplate="headerTemplate">
    <ng-container *ngTemplateOutlet="headerTemplate"></ng-container>
</ng-template>
<ng-template #headerTextCellTemplate let-column="column">
    {{ column.label }}
</ng-template>
